{% extends "base.html" %}
{% block title %}Stall â€“ {{ stall.name }}{% endblock %}

{% block content %}
<div class="fm-card fm-menu">
    <!-- Kopf -->
    <div class="fm-header">
        <img src="{{ url_for('static', filename='images/FarmManager_Logo.png') }}" alt="Logo" class="fm-logo" onerror="this.style.display='none'">
        <h1 class="fm-hello">{{ stall.name }}</h1>
        <a href="{{ url_for('einstellungen.index') }}" class="fm-settings" title="Einstellungen">âš™ï¸</a>
    </div>

    <!-- Schnell â€“ Eier-Produktion -->
    <div class="section">
        <div class="section-title">Schnell â€“ Eier-Produktion</div>

        <form method="POST" action="{{ url_for('huehner.quick_production', stall_id=stall.id) }}">
            <input type="hidden" name="menge" id="p_hiddenMenge" value="0">

            <div class="chips-row">
                <button type="button" class="pill p-qty" data-val="1">+1</button>
                <button type="button" class="pill p-qty" data-val="6">+6</button>
                <button type="button" class="pill p-qty" data-val="10">+10</button>
                <button type="button" class="pill p-qty" data-val="30">+30</button>

                <input type="number" id="p_custom" class="fm-input"
                       placeholder="â€¦" style="width:80px;text-align:center;font-size:.9rem;">
                <button type="button" class="pill pill-clear" id="p_reset">ZurÃ¼cksetzen</button>
            </div>

            <div class="summary-bar mt-2 big-summary">
                <span class="summary-label">Menge</span>
                <span id="p_current">0</span>
            </div>

            <!-- erscheint erst bei Menge > 0 -->
            <button type="submit" id="p_book" class="btn btn-green w-100 mt-2" style="display:none;">Produktion buchen</button>
        </form>
    </div>

    <hr class="soft-divider">

    <!-- Ereignisse -->
    <div class="section">
        <div class="section-title">Ereignis erfassen</div>

        <div class="abg-grid" id="ev_types" aria-label="Ereignisart wÃ¤hlen">
            <div class="grid-item type-tile" data-type="fuetterung" role="button" tabindex="0">
                <div class="icon">ğŸª£</div><div class="fm-txt">FÃ¼tterung</div>
            </div>
            <div class="grid-item type-tile" data-type="wasser" role="button" tabindex="0">
                <div class="icon">ğŸ’§</div><div class="fm-txt">Wasser</div>
            </div>
            <div class="grid-item type-tile" data-type="ausmisten" role="button" tabindex="0">
                <div class="icon">ğŸ§¹</div><div class="fm-txt">Ausmisten</div>
            </div>
            <div class="grid-item type-tile" data-type="umstallung" role="button" tabindex="0">
                <div class="icon">ğŸšš</div><div class="fm-txt">Umstallung</div>
            </div>
            <div class="grid-item type-tile" data-type="verlust" role="button" tabindex="0">
                <div class="icon">âŒ</div><div class="fm-txt">Verlust</div>
            </div>
            <div class="grid-item type-tile" data-type="notiz" role="button" tabindex="0">
                <div class="icon">ğŸ“</div><div class="fm-txt">Notiz</div>
            </div>
        </div>

        <form method="POST" action="{{ url_for('huehner.event', stall_id=stall.id) }}" class="mt-3">
            <input type="hidden" name="typ"   id="ev_typ">
            <input type="hidden" name="menge" id="ev_menge" value="0">

            <!-- Menge nur bei Verlust -->
            <div class="chips-row" id="ev_qty_row" style="display:none;">
                <button type="button" class="pill ev-qty" data-val="1">+1</button>
                <button type="button" class="pill ev-qty" data-val="5">+5</button>
                <button type="button" class="pill ev-qty" data-val="10">+10</button>
                <button type="button" class="pill ev-qty" data-val="20">+20</button>

                <input type="number" id="ev_custom" class="fm-input"
                       placeholder="â€¦" style="width:80px;text-align:center;font-size:.9rem;">
                <button type="button" class="pill pill-clear" id="ev_reset">ZurÃ¼cksetzen</button>
            </div>

            <!-- Notiz / Standort -->
            <div class="mt-2">
                <input type="text" class="fm-input" name="note" placeholder="Notiz / neuer Standort (optional)">
            </div>

            <div class="summary-bar mt-2 big-summary">
                <span class="summary-label">Typ</span><span id="ev_type_label">â€“</span>
                <span class="summary-label">Menge</span><span id="ev_qty_label">0</span>
            </div>

            <!-- erscheint nur, wenn Auswahl valide -->
            <button type="submit" id="ev_book" class="btn btn-red w-100 mt-2" style="display:none;">Ereignis buchen</button>
        </form>
    </div>

    <hr class="soft-divider">

    <!-- Letzte EintrÃ¤ge -->
    <div class="section">
        <div class="section-title">Letzte EintrÃ¤ge</div>
        {% if recent %}
        <div class="table-responsive">
            <table class="table table-sm align-middle">
                <thead>
                <tr>
                    <th>Datum</th><th>Uhrzeit</th><th>Typ</th><th>Menge</th><th>Details</th><th>Benutzer</th>
                </tr>
                </thead>
                <tbody>
                {% for r in recent %}
                <tr>
                    <td>{{ r.datum or '' }}</td>
                    <td>{{ r.zeitpunkt or '' }}</td>
                    <td>{{ r.typ }}</td>
                    <td>{{ r.menge }}</td>
                    <td>{{ r.name }}</td>
                    <td>{{ r.benutzer }}</td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-muted">Noch keine EintrÃ¤ge.</div>
        {% endif %}
    </div>

    <div class="fm-actions">
        <a href="{{ url_for('huehner.menu') }}" class="btn btn-outline">â¬…ï¸ ZurÃ¼ck</a>
    </div>
</div>

<script>
    // -------- Produktion --------
    let p_total = 0;
    const p_current = document.getElementById('p_current');
    const p_hidden  = document.getElementById('p_hiddenMenge');
    const p_book    = document.getElementById('p_book');

    function p_update(){
        p_current.textContent = p_total;
        p_hidden.value = p_total;
        p_book.style.display = p_total > 0 ? 'block' : 'none';
    }

    document.querySelectorAll('.p-qty').forEach(b=>{
        b.addEventListener('click', ()=>{ p_total += parseInt(b.dataset.val); p_update(); });
    });
    document.getElementById('p_custom').addEventListener('change', e=>{
        const v = parseInt(e.target.value);
        if(!isNaN(v) && v > 0){ p_total += v; e.target.value = ''; p_update(); }
    });
    document.getElementById('p_reset').addEventListener('click', ()=>{ p_total = 0; p_update(); });
    p_update();

    // -------- Ereignisse --------
    let ev_type=null, ev_qty=0;
    const evTypeInput=document.getElementById('ev_typ');
    const evMengeInput=document.getElementById('ev_menge');
    const evTypeLabel=document.getElementById('ev_type_label');
    const evQtyLabel=document.getElementById('ev_qty_label');
    const evBookBtn=document.getElementById('ev_book');
    const qtyRow=document.getElementById('ev_qty_row');

    const typeMap = {
        fuetterung:'FÃ¼tterung', wasser:'Wasser', ausmisten:'Ausmisten',
        umstallung:'Umstallung/Standort', verlust:'Verlust', notiz:'Notiz'
    };

    function ev_update(){
        evTypeInput.value = ev_type || '';
        evMengeInput.value = ev_qty;
        evTypeLabel.textContent = ev_type ? typeMap[ev_type] : 'â€“';
        evQtyLabel.textContent = ev_qty;

        const needQty = ev_type === 'verlust';
        qtyRow.style.display = needQty ? 'flex' : 'none';
        evBookBtn.style.display = ev_type && (!needQty || ev_qty>0) ? 'block':'none';
    }

    function setTypeTileActive(tile){
        document.querySelectorAll('.type-tile').forEach(x=>x.classList.remove('active'));
        tile.classList.add('active');
    }

    document.querySelectorAll('.type-tile').forEach(t=>{
        t.addEventListener('click', ()=>{ setTypeTileActive(t); ev_type = t.dataset.type; ev_qty = 0; ev_update(); });
        t.addEventListener('keypress', (e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); t.click(); }});
    });

    document.querySelectorAll('.ev-qty').forEach(p=>{
        p.addEventListener('click', ()=>{ ev_qty += parseInt(p.dataset.val); ev_update(); });
    });
    document.getElementById('ev_custom').addEventListener('change', e=>{
        const v = parseInt(e.target.value);
        if(!isNaN(v) && v>0){ ev_qty += v; e.target.value=''; ev_update(); }
    });
    document.getElementById('ev_reset').addEventListener('click', ()=>{ ev_qty=0; ev_update(); });
    ev_update();
</script>
{% endblock %}
