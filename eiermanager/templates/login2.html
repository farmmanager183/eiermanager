<!doctype html>
<html lang="de">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Login – FarmManager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/farm.css') }}">
    <style>
        body {
            background: linear-gradient(135deg, #eaf8e1, #d8f2cb);
            min-height: 100vh; margin:0; display:grid; place-items:center;
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        }
        .login-container {
            background:#fff; padding:30px; border-radius:1.5rem;
            box-shadow:0 8px 24px rgba(0,0,0,.1);
            width:min(380px, 92vw); text-align:center;
        }
        .logo { width:100px; margin-bottom:14px; }
        h2 { font-weight:600; font-size:1.25rem; margin-bottom: 1rem; }

        .pin-display {
            font-size:2.2rem; letter-spacing:18px;
            height:40px; margin:16px 0 20px;
        }
        .pin-pad {
            display:grid; grid-template-columns:repeat(3,1fr);
            gap:14px; justify-items:center;
        }
        .pin-pad .btn {
            width:80px; height:80px;
            border-radius:16px;
            font-size:1.6rem; font-weight:600;
            display:flex; align-items:center; justify-content:center;
            box-shadow:0 2px 6px rgba(0,0,0,.08);
            transition: all .1s ease;
        }
        .pin-pad .btn:hover { transform:translateY(-2px); box-shadow:0 6px 14px rgba(0,0,0,.12); }
        .pin-pad .btn:active { transform:scale(.96); }
        .btn-clear {
            grid-column:span 3;
            width:100%; height:56px;
            font-size:1.1rem; font-weight:600;
            border-radius:12px;
        }
    </style>
</head>
<body>
<div class="login-container">
    <img src="{{ url_for('static', filename='images/FarmManager_Logo.png') }}" alt="Logo"
         class="logo" onerror="this.style.display='none'">
    <h2>PIN eingeben</h2>

    <!-- Flash-Messages (z.B. falsche PIN) -->
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <div class="mb-2">
        {% for category, message in messages %}
        <div class="alert alert-{{ 'warning' if category=='message' else category }} py-2 mb-2" role="alert">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}
    {% endwith %}

    <form method="POST" action="{{ url_for('benutzer.login') }}" id="pin-form" autocomplete="off" novalidate>
        <input type="password" id="pin" name="pin" maxlength="4" inputmode="numeric" pattern="\\d{4}"
               required class="d-none" aria-label="4-stellige PIN">
        <div class="pin-display" id="pin-display" aria-live="polite" aria-atomic="true"></div>

        <div class="pin-pad">
            {% for num in [1,2,3,4,5,6,7,8,9] %}
            <button type="button" class="btn btn-outline-secondary" onclick="addDigit('{{ num }}')" aria-label="Ziffer {{ num }}">{{ num }}</button>
            {% endfor %}
            <div></div>
            <button type="button" class="btn btn-outline-secondary" onclick="addDigit('0')" aria-label="Ziffer 0">0</button>
            <div></div>

            <button type="button" class="btn btn-danger btn-clear mt-1" id="btn-clear" aria-label="PIN löschen">Löschen</button>
        </div>
    </form>
</div>

<script>
    let pin = "";
    const pinInput = document.getElementById("pin");
    const display  = document.getElementById("pin-display");
    const form     = document.getElementById("pin-form");

    function updateDisplay() { display.textContent = pin.split("").map(() => "•").join(" "); }
    function submitWhenFull() { if (pin.length === 4) setTimeout(() => form.submit(), 100); }
    function addDigit(d) {
        if (pin.length < 4) {
            pin += d;
            pinInput.value = pin;
            updateDisplay();
            submitWhenFull();
        }
    }
    function clearPin() { pin = ""; pinInput.value = ""; updateDisplay(); }

    document.getElementById("btn-clear").addEventListener("click", clearPin);
    document.addEventListener('keydown', (e) => {
        if (/^\d$/.test(e.key)) addDigit(e.key);
        if (e.key === 'Backspace') { e.preventDefault(); clearPin(); }
    });
    updateDisplay();
</script>
</body>
</html>
